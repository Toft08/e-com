services:
  # -------------------
  # Kafka (KRaft mode - no Zookeeper needed)
  # -------------------
  kafka:
    image: apache/kafka:3.8.1
    container_name: buyapp-kafka
    ports:
      - '9092:9092'
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3
    networks:
      - buy-01-network

  # -------------------
  # MongoDB
  # -------------------
  mongodb:
    image: mongo:latest
    container_name: buyapp-mongodb
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - mongodb_data:/data/db
    networks:
      - buy-01-network
    healthcheck:
      test:
        [
          'CMD',
          'mongosh',
          '--username',
          'admin',
          '--password',
          'password',
          '--eval',
          "db.adminCommand('ping')",
        ]
      interval: 5s
      timeout: 2s
      retries: 10

  # -------------------
  # Backend services
  # -------------------
  eureka-server:
    build: ./backend/services/eureka
    container_name: buyapp-eureka-server
    ports:
      - '8761:8761'
    networks:
      - buy-01-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8761/actuator/health']
      interval: 5s
      timeout: 2s
      retries: 10

  api-gateway:
    build: ./backend/api-gateway
    container_name: buyapp-api-gateway
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    ports:
      - '8080:8080'
    networks:
      - buy-01-network
    depends_on:
      eureka-server:
        condition: service_healthy

  user-service:
    build: ./backend/services/user
    container_name: buyapp-user-service
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: true
      SPRING_DATA_MONGODB_URI: mongodb://admin:password@mongodb:27017/buy01?authSource=admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8081'
    networks:
      - buy-01-network
    depends_on:
      eureka-server:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  product-service:
    build: ./backend/services/product
    container_name: buyapp-product-service
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: true
      SPRING_DATA_MONGODB_URI: mongodb://admin:password@mongodb:27017/buy01?authSource=admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8082'
    networks:
      - buy-01-network
    depends_on:
      eureka-server:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  media-service:
    build: ./backend/services/media
    container_name: buyapp-media-service
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: true
      SPRING_DATA_MONGODB_URI: mongodb://admin:password@mongodb:27017/buy01?authSource=admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8083'
    networks:
      - buy-01-network
    volumes:
      - ./backend/services/media/uploads:/app/uploads
    depends_on:
      eureka-server:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # -------------------
  # Frontend
  # -------------------
  frontend:
    build: ./frontend
    container_name: buyapp-frontend
    ports:
      - '4200:80'
    networks:
      - buy-01-network
    depends_on:
      - api-gateway

# -------------------
# Networks & Volumes
# -------------------
networks:
  buy-01-network:

volumes:
  mongodb_data:
