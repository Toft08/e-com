services:
  # -------------------
  # Kafka (KRaft mode - no Zookeeper needed)
  # -------------------
  kafka:
    image: apache/kafka:3.8.1
    container_name: ecom-kafka
    expose:
      - '9092'
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3
    networks:
      - ecom-network

  # -------------------
  # MongoDB
  # -------------------
  mongodb:
    image: mongo:latest
    container_name: ecom-mongodb
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - mongodb_data:/data/db
    networks:
      - ecom-network
    healthcheck:
      test:
        [
          'CMD',
          'mongosh',
          '--eval',
          "db.adminCommand('ping')",
          '-u',
          'admin',
          '-p',
          'password',
          '--authenticationDatabase',
          'admin',
        ]
      interval: 5s
      timeout: 2s
      retries: 10

  # -------------------
  # Backend services
  # -------------------
  eureka-server:
    build:
      context: ./backend
      dockerfile: ./services/eureka/Dockerfile
    container_name: ecom-eureka-server
    ports:
      - '8761:8761'
    networks:
      - ecom-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8761/actuator/health']
      interval: 5s
      timeout: 2s
      retries: 10

  api-gateway:
    build:
      context: ./backend
      dockerfile: ./api-gateway/Dockerfile
    container_name: ecom-api-gateway
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    ports:
      - '8080:8080'
    networks:
      - ecom-network
    healthcheck:
      test: ['CMD', 'curl', '-k', '-f', 'https://localhost:8080/actuator/health']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    depends_on:
      eureka-server:
        condition: service_healthy
      user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      media-service:
        condition: service_healthy

  user-service:
    build:
      context: ./backend
      dockerfile: ./services/user/Dockerfile
    container_name: ecom-user-service
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: true
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_USERNAME: admin
      SPRING_DATA_MONGODB_PASSWORD: password
      SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE: admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8081'
    networks:
      - ecom-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8081/actuator/health']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    depends_on:
      eureka-server:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  product-service:
    build:
      context: ./backend
      dockerfile: ./services/product/Dockerfile
    container_name: ecom-product-service
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: true
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_USERNAME: admin
      SPRING_DATA_MONGODB_PASSWORD: password
      SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE: admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8082'
    networks:
      - ecom-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8082/actuator/health']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    depends_on:
      eureka-server:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  media-service:
    build:
      context: ./backend
      dockerfile: ./services/media/Dockerfile
    container_name: ecom-media-service
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: true
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_USERNAME: admin
      SPRING_DATA_MONGODB_PASSWORD: password
      SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE: admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8083'
    networks:
      - ecom-network
    volumes:
      - ./backend/services/media/uploads:/app/uploads
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8083/actuator/health']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    depends_on:
      eureka-server:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # -------------------
  # Frontend
  # -------------------
  frontend:
    build:
      context: ./frontend
      args:
        API_URL: https://api-gateway:8080
    container_name: ecom-frontend
    ports:
      - '4200:443'
    networks:
      - ecom-network
    depends_on:
      api-gateway:
        condition: service_healthy

# -------------------
# Networks & Volumes
# -------------------
networks:
  ecom-network:

volumes:
  mongodb_data:
